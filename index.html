<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PassPocket</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Styles & Animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pass-card {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
        }

        .pass-card:active {
            transform: scale(0.96);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #38bdf8;
            box-shadow: 0 0 15px #38bdf8;
            animation: scan 2s infinite linear;
            display: none;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .scanning .scan-line {
            display: block;
        }

        /* View Transitions */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .view-section.active {
            display: flex;
            opacity: 1;
        }

        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Color Pickers */
        .color-dot {
            transition: transform 0.2s;
        }
        .color-dot.selected {
            transform: scale(1.2);
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative">

    <!-- ==================== HOME VIEW ==================== -->
    <div id="view-home" class="view-section active flex-col h-full w-full p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gradient">PassPocket</h1>
                <p class="text-slate-400 text-sm mt-1">Your digital wallet</p>
            </div>
            <button onclick="openSettings()" class="p-2 rounded-full hover:bg-white/10 transition">
                <i class="ph ph-gear text-xl"></i>
            </button>
        </div>

        <!-- Grid of Passes -->
        <div id="pass-grid" class="flex-1 overflow-y-auto pb-24 grid grid-cols-1 gap-4">
            <!-- Empty State (Populated by JS) -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center h-64 text-center">
                <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4">
                    <i class="ph ph-cards text-3xl text-slate-500"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-300">No passes yet</h3>
                <p class="text-slate-500 text-sm max-w-xs mt-2">Tap the + button to scan and save your first pass.</p>
            </div>
        </div>

        <!-- Floating Action Button -->
        <div class="absolute bottom-6 left-0 w-full flex justify-center z-10">
            <button onclick="startCamera()" class="group flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-6 py-4 rounded-full shadow-lg shadow-blue-500/30 transition-all transform hover:scale-105 active:scale-95">
                <i class="ph ph-plus text-xl font-bold"></i>
                <span class="font-semibold">Add Pass</span>
            </button>
        </div>
    </div>

    <!-- ==================== CAMERA VIEW ==================== -->
    <div id="view-camera" class="view-section flex-col h-full w-full bg-black z-50">
        <!-- Top Bar -->
        <div class="absolute top-0 w-full p-6 flex justify-between items-center z-20">
            <button onclick="closeCamera()" class="p-3 bg-black/40 backdrop-blur rounded-full text-white">
                <i class="ph ph-x text-xl"></i>
            </button>
            <span class="text-sm font-medium bg-black/40 px-3 py-1 rounded-full backdrop-blur">Align Code</span>
        </div>

        <!-- Camera Preview -->
        <div class="relative flex-1 flex items-center justify-center overflow-hidden">
            <video id="camera-stream" autoplay playsinline class="absolute w-full h-full object-cover"></video>
            
            <!-- Focus Frame -->
            <div class="relative w-64 h-48 border-2 border-white/30 rounded-xl z-10 flex items-center justify-center scanning">
                <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-blue-400 -mt-1 -ml-1 rounded-tl"></div>
                <div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-blue-400 -mt-1 -mr-1 rounded-tr"></div>
                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-blue-400 -mb-1 -ml-1 rounded-bl"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-blue-400 -mb-1 -mr-1 rounded-br"></div>
                <div class="scan-line"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="h-32 bg-black flex items-center justify-center gap-8 pb-6">
             <!-- File Upload Fallback -->
            <label class="p-4 rounded-full bg-white/10 text-white cursor-pointer">
                <i class="ph ph-image text-xl"></i>
                <input type="file" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            </label>

            <!-- Shutter Button -->
            <button onclick="capturePhoto()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center">
                <div class="w-16 h-16 bg-white rounded-full active:scale-90 transition"></div>
            </button>

            <!-- Flip Camera -->
             <button onclick="switchCamera()" class="p-4 rounded-full bg-white/10 text-white">
                <i class="ph ph-camera-rotate text-xl"></i>
            </button>
        </div>
    </div>

    <!-- ==================== EDITOR VIEW ==================== -->
    <div id="view-editor" class="view-section flex-col h-full w-full bg-slate-900 z-40 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigate('view-home')" class="p-2 -ml-2 rounded-full hover:bg-white/10">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <h2 class="text-xl font-bold">New Pass</h2>
            </div>

            <!-- Image Preview -->
            <div class="w-full h-48 bg-slate-800 rounded-2xl mb-6 overflow-hidden relative shadow-lg">
                <img id="editor-preview" src="" class="w-full h-full object-contain bg-white">
                <div class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded text-xs text-white backdrop-blur">Preview</div>
            </div>

            <!-- Form -->
            <div class="space-y-6">
                <!-- Title -->
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Pass Name</label>
                    <input type="text" id="pass-title" placeholder="e.g. Gym Membership" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 transition">
                </div>

                <!-- Colors -->
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Card Color</label>
                    <div class="flex gap-4 overflow-x-auto py-2" id="color-picker">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Icon -->
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Icon</label>
                    <div class="flex gap-3 overflow-x-auto py-2 no-scrollbar" id="icon-picker">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <button onclick="savePass()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-600/20 mt-4 transition active:scale-95">
                    Save Pass
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== DETAIL/FULLSCREEN VIEW ==================== -->
    <div id="view-pass" class="view-section flex-col h-full w-full bg-slate-900 z-50">
        <!-- Navbar -->
        <div class="flex justify-between items-center p-6">
            <button onclick="closePassView()" class="p-2 rounded-full bg-slate-800 text-white hover:bg-slate-700">
                <i class="ph ph-x text-xl"></i>
            </button>
            <div class="flex gap-2">
                <button onclick="deleteCurrentPass()" class="p-2 rounded-full bg-red-500/10 text-red-400 hover:bg-red-500/20">
                    <i class="ph ph-trash text-xl"></i>
                </button>
            </div>
        </div>

        <!-- The Pass -->
        <div class="flex-1 flex flex-col items-center justify-center p-6">
            <div id="full-pass-card" class="w-full max-w-sm bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl p-6 shadow-2xl shadow-blue-900/40 transform transition-all">
                <!-- Card Header -->
                <div class="flex items-start justify-between mb-8">
                    <div>
                        <h2 id="full-pass-title" class="text-2xl font-bold text-white drop-shadow-md">Gym Card</h2>
                        <p class="text-white/70 text-sm mt-1">Scan at terminal</p>
                    </div>
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <i id="full-pass-icon" class="ph ph-barbell text-2xl text-white"></i>
                    </div>
                </div>

                <!-- Barcode Area -->
                <div class="bg-white rounded-xl p-4 shadow-inner flex items-center justify-center min-h-[200px]">
                    <img id="full-pass-image" src="" class="max-w-full max-h-[250px] object-contain mix-blend-multiply">
                </div>

                <!-- Footer info -->
                <div class="mt-6 flex justify-between items-center">
                    <span class="text-xs text-white/50 font-mono" id="pass-id-display">ID: 839201</span>
                    <div class="flex gap-1">
                        <div class="w-2 h-2 rounded-full bg-white/80"></div>
                        <div class="w-2 h-2 rounded-full bg-white/40"></div>
                    </div>
                </div>
            </div>

            <p class="text-slate-500 text-sm mt-8 flex items-center gap-2">
                <i class="ph ph-sun-dim"></i> Increase brightness for scanning
            </p>
        </div>
    </div>

    <!-- Hidden Canvas for processing -->
    <canvas id="process-canvas" class="hidden"></canvas>

    <!-- JavaScript Logic -->
    <script>
        // --- State Management ---
        let passes = JSON.parse(localStorage.getItem('saved_passes')) || [];
        let currentStream = null;
        let currentImageBase64 = null;
        let selectedColor = 'from-blue-500 to-blue-600';
        let selectedIcon = 'ph-ticket';
        let activePassId = null;
        let currentFacingMode = 'environment';

        // --- Config Data ---
        const colors = [
            { id: 'blue', class: 'from-blue-500 to-cyan-500', bg: 'bg-blue-500' },
            { id: 'purple', class: 'from-violet-500 to-purple-500', bg: 'bg-purple-500' },
            { id: 'rose', class: 'from-rose-500 to-pink-500', bg: 'bg-rose-500' },
            { id: 'orange', class: 'from-orange-500 to-amber-500', bg: 'bg-orange-500' },
            { id: 'emerald', class: 'from-emerald-500 to-teal-500', bg: 'bg-emerald-500' },
            { id: 'slate', class: 'from-slate-700 to-slate-800', bg: 'bg-slate-700' },
        ];

        const icons = [
            'ph-ticket', 'ph-airplane-tilt', 'ph-barbell', 'ph-coffee', 
            'ph-shopping-cart', 'ph-qr-code', 'ph-bus', 'ph-film-strip', 'ph-id-card'
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPassList();
            setupEditorUI();
        });

        // --- Navigation ---
        function navigate(viewId) {
            // Stop camera if leaving camera view
            if (viewId !== 'view-camera' && currentStream) {
                stopCamera();
            }

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                // Small delay to allow display:none to apply after opacity fade out
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 300);
            });

            const target = document.getElementById(viewId);
            target.style.display = 'flex';
            // Force reflow
            void target.offsetWidth;
            target.classList.add('active');
        }

        // --- Camera Logic ---
        async function startCamera() {
            navigate('view-camera');
            try {
                const constraints = {
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('camera-stream');
                video.srcObject = currentStream;
            } catch (err) {
                console.error("Camera error:", err);
                alert("Could not access camera. Please use the upload button.");
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function closeCamera() {
            stopCamera();
            navigate('view-home');
        }

        function switchCamera() {
            stopCamera();
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startCamera();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    processImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('process-canvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw current video frame
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            processImage(dataUrl);
        }

        function processImage(dataUrl) {
            // Compress and Resize logic
            const img = new Image();
            img.src = dataUrl;
            img.onload = () => {
                const canvas = document.getElementById('process-canvas');
                const ctx = canvas.getContext('2d');
                
                // Max width 800px to save storage
                const maxWidth = 800;
                const scale = maxWidth / img.width;
                const width = Math.min(img.width, maxWidth);
                const height = img.height * (img.width > maxWidth ? scale : 1);

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // Save low quality jpeg for storage
                currentImageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                
                // Go to Editor
                document.getElementById('editor-preview').src = currentImageBase64;
                stopCamera();
                navigate('view-editor');
            };
        }

        // --- Editor Logic ---
        function setupEditorUI() {
            // Colors
            const colorContainer = document.getElementById('color-picker');
            colorContainer.innerHTML = colors.map(c => `
                <div onclick="selectColor('${c.class}', this)" 
                     class="color-dot w-10 h-10 rounded-full ${c.bg} flex-shrink-0 cursor-pointer ${c.class === selectedColor ? 'selected' : ''}">
                </div>
            `).join('');

            // Icons
            const iconContainer = document.getElementById('icon-picker');
            iconContainer.innerHTML = icons.map(i => `
                <div onclick="selectIcon('${i}', this)" 
                     class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center cursor-pointer border border-slate-700 hover:border-blue-500 transition ${i === selectedIcon ? 'border-blue-500 bg-slate-700' : ''}">
                    <i class="ph ${i} text-2xl text-white"></i>
                </div>
            `).join('');
        }

        function selectColor(colorClass, el) {
            selectedColor = colorClass;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        function selectIcon(iconClass, el) {
            selectedIcon = iconClass;
            document.querySelectorAll('#icon-picker > div').forEach(d => {
                d.classList.remove('border-blue-500', 'bg-slate-700');
                d.classList.add('border-slate-700');
            });
            el.classList.remove('border-slate-700');
            el.classList.add('border-blue-500', 'bg-slate-700');
        }

        function savePass() {
            const title = document.getElementById('pass-title').value.trim() || 'Untitled Pass';
            
            const newPass = {
                id: Date.now(),
                title: title,
                image: currentImageBase64,
                color: selectedColor,
                icon: selectedIcon,
                date: new Date().toLocaleDateString()
            };

            passes.unshift(newPass); // Add to top
            localStorage.setItem('saved_passes', JSON.stringify(passes));
            
            // Reset form
            document.getElementById('pass-title').value = '';
            
            renderPassList();
            navigate('view-home');
        }

        // --- Render List ---
        function renderPassList() {
            const grid = document.getElementById('pass-grid');
            const emptyState = document.getElementById('empty-state');
            
            // Remove current cards (keep empty state div)
            Array.from(grid.children).forEach(child => {
                if(child.id !== 'empty-state') child.remove();
            });

            if (passes.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');

                passes.forEach(pass => {
                    const el = document.createElement('div');
                    el.className = `glass-panel pass-card rounded-2xl p-4 flex items-center gap-4 cursor-pointer hover:bg-white/5`;
                    el.onclick = () => openPass(pass.id);
                    
                    // Extract color for left bar border
                    const bgClass = pass.color;

                    el.innerHTML = `
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br ${bgClass} flex items-center justify-center shadow-lg">
                            <i class="ph ${pass.icon} text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">${pass.title}</h3>
                            <p class="text-xs text-slate-400">Added ${pass.date}</p>
                        </div>
                        <i class="ph ph-caret-right text-slate-500"></i>
                    `;
                    grid.appendChild(el);
                });
            }
        }

        // --- View Pass Logic ---
        function openPass(id) {
            const pass = passes.find(p => p.id === id);
            if (!pass) return;

            activePassId = id;
            
            const card = document.getElementById('full-pass-card');
            
            // Remove old gradient classes and add new one
            card.className = `w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all bg-gradient-to-br ${pass.color}`;
            
            document.getElementById('full-pass-title').innerText = pass.title;
            document.getElementById('full-pass-icon').className = `ph ${pass.icon} text-2xl text-white`;
            document.getElementById('full-pass-image').src = pass.image;
            document.getElementById('pass-id-display').innerText = `ID: ${pass.id}`;

            navigate('view-pass');
        }

        function closePassView() {
            navigate('view-home');
            activePassId = null;
        }

        function deleteCurrentPass() {
            if (confirm('Are you sure you want to delete this pass?')) {
                passes = passes.filter(p => p.id !== activePassId);
                localStorage.setItem('saved_passes', JSON.stringify(passes));
                renderPassList();
                closePassView();
            }
        }

        function openSettings() {
            // Simple clear data for now
            if(confirm("Clear all saved data? This cannot be undone.")) {
                localStorage.clear();
                location.reload();
            }
        }

    </script>
</body>
</html>
